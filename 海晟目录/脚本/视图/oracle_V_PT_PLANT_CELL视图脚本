DROP VIEW TSO.V_PT_PLANT_CELL;
CREATE VIEW TSO.V_PT_PLANT_CELL
   AS
SELECT DISTINCT
	A.DATA_STORE_BASE_TBL_ID AS ID, 
	A.FEEDBACK_DATE, 											--	采集日期
	A.PT_YEAR AS BUSINESS_YEAR, 
	A.CLT_OBJ_ID AS PLANT_CELL_ID, 				--种植单元id 
	A.CLT_OBJ_CD AS PLANT_CELL_CD, 				--种植单元编号
  A.CLT_OBJ_NAME AS PLANT_CELL_NAME, 		-- 种植单元名称
  A.N1 AS PLANT_AREA,										--种植面积
  A.C1 AS BAKER_ID,											--烤师ID
  B.NAME AS BAKER_NAME, 								-- 烤师名称
  A.C2 AS TECHNICIAN_ID,								--烟技员id
  C.PSN_NAME AS TECHNICIAN_NAME, 				--烟技员姓名
  A.C4 AS LEAF_VARIETY_CD, 							--烟叶品种代码(可能存在多个，用逗号隔开)
  P.CANOPY_QTY,    											--育苗棚数量
  D.ROAST_HOUSE_QTY, 										--烤房数量
  E.FARMER_QTY, 												--烟农数量
  CASE
		WHEN A.FILE_GROUP_ID IS NULL
    		OR
    		A.FILE_GROUP_ID='' THEN
   		 	'未上传'
		ELSE
    		'已上传'
	END AS PIC_UPLOAD_STATUS, 						--图片上传情况
	
	A.ORG_UNIQUE_CD              AS ORG_CD,
  F.ORG_CD                     AS SSTC,
  F.ORG_NAME                   AS SSTC_NAME,
  G.ORG_CD                     AS STAC,
  G.ORG_NAME                   AS STAC_NAME,
  H.ORG_CD                     AS COUC,
  H.ORG_ABBR                   AS COUC_NAME,
  I.ORG_CD                     AS CITC,
  I.ORG_ABBR                   AS CITC_NAME,                
  J.ORG_CD                     AS PROV,
  J.ORG_ABBR                   AS PROV_NAME, 
  
  A.V_DIVISION_UNIQUE_CD 				AS DIV_CD,
  K.DIVISION_UNIQUE_CD 					AS AREA_VAGE,
  K.DIVISION_NAME 							AS VAGE_NAME,
  L.DIVISION_UNIQUE_CD 					AS AREA_TOWN,
  L.DIVISION_NAME 							AS TOWN_NAME,
  M.DIVISION_UNIQUE_CD 					AS AREA_COUC,
  M.DIVISION_NAME 							AS AREA_COUC_NAME,
  N.DIVISION_UNIQUE_CD 					AS AREA_CITC,
  N.DIVISION_NAME 							AS AREA_CITC_NAME,
  O.DIVISION_UNIQUE_CD 					AS AREA_PROV,
  O.DIVISION_NAME 							AS AREA_PROV_NAME,
  
  A.SEND_STATE,
  A.DATA_STATE,
  A.MODIFY_TIME,
  A.LAST_TIME
  
FROM
	PT_DC_STAT_DATA_Z A
LEFT JOIN BA_BAKER B ON A.C1 = B.BAKER_ID AND B.DATA_STATE='1'
LEFT JOIN CM_OM_STAFF C ON A.C2 = C.STAFF_ID AND C.DATA_STATE='1' 
LEFT JOIN 
	(
		SELECT
      BAKER_ID,
      BUSINESS_YEAR,
      COUNT(DISTINCT FRM_CD) AS ROAST_HOUSE_QTY
    FROM
        BA_BAKER_AND_FRM_FUND BAKER
    WHERE
        RELA_OBJ_TYPE_EK='ROAST'
    AND DATA_STATE='1'
    GROUP BY
        BAKER_ID,
        BUSINESS_YEAR
	) D ON A.C1 = D.BAKER_ID AND A.PT_YEAR = CAST(D.BUSINESS_YEAR AS DECIMAL(10,0))
LEFT JOIN
	(
		SELECT
      BAKER_ID,
      BUSINESS_YEAR,
      COUNT(DISTINCT FRM_CD) AS FARMER_QTY
    FROM
        BA_BAKER_AND_FRM_FUND BAKER
    WHERE
        RELA_OBJ_TYPE_EK='FARMER'
    AND DATA_STATE='1'
    GROUP BY
        BAKER_ID,
        BUSINESS_YEAR
	) E ON A.C1 = E.BAKER_ID AND A.PT_YEAR = CAST(D.BUSINESS_YEAR AS DECIMAL(10,0))
/*烟点信息*/
LEFT JOIN CM_OM_ORG_MAIN F  ON A.ORG_UNIQUE_CD = F.ORG_UNIQUE_CD
/*烟站信息*/
LEFT JOIN CM_OM_ORG_MAIN G  ON F.STAT_UNIQUE_CD = G.ORG_UNIQUE_CD
/*县公司信息*/
LEFT JOIN CM_OM_ORG_MAIN H  ON G.COUN_UNIQUE_CD = H.ORG_UNIQUE_CD
/*市公司信息*/
LEFT JOIN CM_OM_ORG_MAIN I  ON H.CITY_UNIQUE_CD = I.ORG_UNIQUE_CD
/*省公司信息*/
LEFT JOIN CM_OM_ORG_MAIN J  ON I.PROV_UNIQUE_CD = J.ORG_UNIQUE_CD 

/*村信息*/
LEFT JOIN CM_OM_DIVISION K ON A.V_DIVISION_UNIQUE_CD = K.DIVISION_UNIQUE_CD
/*镇信息*/
LEFT JOIN CM_OM_DIVISION L ON K.TOWN_UNIQUE_CD = L.DIVISION_UNIQUE_CD
/*县信息*/
LEFT JOIN CM_OM_DIVISION M ON L.COUN_UNIQUE_CD = M.DIVISION_UNIQUE_CD
/*市信息*/
LEFT JOIN CM_OM_DIVISION N ON M.CITY_UNIQUE_CD = N.DIVISION_UNIQUE_CD
/*省信息*/
LEFT JOIN CM_OM_DIVISION O ON N.PROV_UNIQUE_CD = O.DIVISION_UNIQUE_CD
LEFT JOIN 
	(
		SELECT
    	LEAF_GUIDER_ID,
    	PT_YEAR,
    	COUNT(DISTINCT FACILITY_ID) AS CANOPY_QTY
		FROM
    	PT_AS_TLG_FACILITY
		WHERE
    	FACILITY_TYPE_EK='GROW_SHACK'
		AND DATA_STATE='1'
		GROUP BY
    		LEAF_GUIDER_ID,
    		PT_YEAR
	) P ON A.C2 = P.LEAF_GUIDER_ID AND A.PT_YEAR = P.PT_YEAR
WHERE 
		A.DATA_STATE='1'
AND A.BILL_NO='TJ1935ZCK0000007'
AND F.DATA_STATE='1' AND F.END_YEAR=9999
AND G.DATA_STATE='1' AND G.END_YEAR=9999
AND H.DATA_STATE='1' AND H.END_YEAR=9999
AND I.DATA_STATE='1' AND I.END_YEAR=9999
AND J.DATA_STATE='1' AND J.END_YEAR=9999
AND K.DATA_STATE='1' AND K.END_YEAR=9999
AND L.DATA_STATE='1' AND L.END_YEAR=9999
AND M.DATA_STATE='1' AND M.END_YEAR=9999
AND N.DATA_STATE='1' AND N.END_YEAR=9999
AND O.DATA_STATE='1' AND O.END_YEAR=9999;

--在DCCELL库执行， 创建视图SYNONYM到DCCELL
CREATE OR REPLACE SYNONYM DCCELL.V_PT_PLANT_CELL   FOR TSO.V_PT_PLANT_CELL@TSO_DBLINK;