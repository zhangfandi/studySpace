--DROP PROCEDURE DCCELL.P_R_PT_FOR_SEED;
CREATE PROCEDURE DCCELL.P_R_PT_FOR_SEED
BEGIN
    DECLARE V_YEAR            INTEGER;
	DECLARE V_CURRENT_TIME     TIMESTAMP;
	
	SET V_CURRENT_TIME = CURRENT TIMESTAMP;

    SELECT BUSI_YEAR INTO V_YEAR
    FROM DC_PROC_BUSI_YEAR A
    WHERE A.PROC_NAME = 'P_DC_CALL_ID_02_SC';

    DELETE FROM R_PT_FOR_SEED_FM_Y where BUSINESS_YEAR>=V_YEAR;
    COMMIT;
	
	  INSERT INTO R_PT_FOR_SEED_FM_Y(
        FOR_SEED_FM_Y_ID,
        FARMER_ID,
        FARMER_CD,
        FARMER_NAME,
        FOR_SEED_DATE,
		FOR_SEED_QTY,
        GROW_POINT_ID,
        GROW_POINT_CD,
        GROW_POINT_NAME,
        LEAF_VARIETY_CD,
        LEAF_VARIETY_NAME,
        DATA_STATE,
        SEND_STATE,
        MODIFY_TIME,
        LAST_TIME, 
        BUSINESS_YEAR,
        ORG_CD,
        ORG_NAME,
        PROV,
        PROV_NAME,
        CITC,
        CITC_NAME,
        COUC,
        COUC_NAME,
        STAC,
        STAC_NAME,
        SSTC,
        SSTC_NAME,
        AREA_CD,
        AREA_NAME,
        AREA_PROV,
        AREA_PROV_NAME,
        AREA_CITC,
        AREA_CITC_NAME,
        AREA_COUC,
        AREA_COUC_NAME,
        AREA_TOWN,
        TOWN_NAME,
        AREA_VAGE,
        VAGE_NAME,
        AREA_GRUP,
        GRUP_NAME  
  )  
  SELECT A.FOR_SEED_FM_Y_ID,
          A.FARMER_ID,
          A.FARMER_CD,
          A.FARMER_NAME,
          A.BUSINESS_DATE,
		  A.FOR_SEED_QTY,
          A.GROW_POINT_ID,
          A.GROW_POINT_CD,
          A.GROW_POINT_NAME,
          A.LEAF_VARIETY_CD,
          B.LEAF_VARIETY_NAME,
        '1' AS DATA_STATE,
        '0' AS SEND_STATE,
        V_CURRENT_TIME AS MODIFY_TIME,
        V_CURRENT_TIME AS LAST_TIME, 
        A.BUSINESS_YEAR,
        E.ORG_CD,
        E.ORG_NAME,
        E.PROV,
        E.PROV_NAME,
        E.CITC,
        E.CITC_NAME,
        E.COUC,
        E.COUC_NAME,
        E.STAC,
        E.STAC_NAME,
        E.SSTC,
        E.SSTC_NAME,
        E.AREA_CD,
        E.AREA_NAME,
        E.AREA_PROV,
        E.AREA_PROV_NAME,
        E.AREA_CITC,
        E.AREA_CITC_NAME,
        E.AREA_COUC,
        E.AREA_COUC_NAME,
        E.AREA_TOWN,
        E.TOWN_NAME,
        E.AREA_VAGE,
        E.VAGE_NAME,
        E.AREA_GRUP,
        E.GRUP_NAME                
  FROM
  (SELECT 
                MAX(A.DATA_STORE_BASE_TBL_ID) AS FOR_SEED_FM_Y_ID,
                A.CLT_OBJ_ID AS FARMER_ID,
                A.CLT_OBJ_CD AS FARMER_CD,
                MAX(A.CLT_OBJ_NAME) AS FARMER_NAME,
                A.D1 AS BUSINESS_DATE,          
                A.PT_YEAR AS BUSINESS_YEAR,
                A.RELA_OBJECT_ID AS GROW_POINT_ID,
                A.RELA_OBJECT_CD AS GROW_POINT_CD,                
                MAX(A.RELA_OBJECT_NAME) AS GROW_POINT_NAME,
                B.LEAF_VARIETY_CD,
                SUM(COALESCE(A.N1,0)) AS FOR_SEED_QTY        
        FROM PT_DC_STAT_DATA_B A
        LEFT JOIN (
           SELECT DATA_STORE_BASE_TBL_ID,
           C2 AS LEAF_VARIETY_CD
           FROM PT_DC_STAT_DATA_B
           WHERE DATA_STATE='1' AND BILL_NO='TJ19HB0000000002'AND PT_YEAR >= V_YEAR
        ) B  ON A.PARENT_REC_ID = B.DATA_STORE_BASE_TBL_ID
        WHERE A.DATA_STATE='1'
        AND A.PT_YEAR >= V_YEAR
        AND A.BILL_NO='TJ19HB0000000005'
        GROUP BY A.CLT_OBJ_ID,A.CLT_OBJ_CD,A.D1,A.RELA_OBJECT_ID,A.RELA_OBJECT_CD,A.PT_YEAR,B.LEAF_VARIETY_CD
        ) A
        left join cm_tb_leaf_variety B ON A.LEAF_VARIETY_CD=b.LEAF_VARIETY_CD AND b.DATA_STATE='1'
        LEFT JOIN R_FARMER E ON A.FARMER_CD=E.FARMER_CD;

	COMMIT;
	
	DELETE FROM R_PT_FOR_SEED_AB_D where BUSINESS_YEAR>=V_YEAR;
    COMMIT;
	
	

	INSERT INTO R_PT_FOR_SEED_AB_D
		(
		 FOR_SEED_AB_D_ID,
		GROW_POINT_ID,
		GROW_POINT_CD,
		GROW_POINT_NAME,
		BUSINESS_DATE ,
		LEAF_VARIETY_CD,
		LEAF_VARIETY_NAME,
		BUSINESS_YEAR,
		FOR_SEED_QTY,
		DATA_STATE,
		SEND_STATE,
		MODIFY_TIME,
		LAST_TIME,
		ORG_CD,
		ORG_NAME,
		PROV,
		PROV_NAME,
		CITC,
		CITC_NAME,
		COUC,
		COUC_NAME,
		STAC,
		STAC_NAME,
		SSTC,
		SSTC_NAME,
		AREA_CD,
		AREA_NAME,
		AREA_PROV,
		AREA_PROV_NAME,
		AREA_CITC,
		AREA_CITC_NAME,
		AREA_COUC,
		AREA_COUC_NAME,
		AREA_TOWN,
		TOWN_NAME,
		AREA_VAGE,
		VAGE_NAME,
		AREA_GRUP,
		GRUP_NAME
		)
	SELECT
		 HEX(GENERATE_UNIQUE()) AS FOR_SEED_AB_D_ID,
		GROW_POINT_ID,
		GROW_POINT_CD,
		GROW_POINT_NAME,
		FOR_SEED_DATE AS BUSINESS_DATE ,
		LEAF_VARIETY_CD,
		LEAF_VARIETY_NAME,
		BUSINESS_YEAR,
		SUM(COALESCE(FOR_SEED_QTY,0)) AS FOR_SEED_QTY,
		'1'                           AS DATA_STATE,
		'0'                           AS SEND_STATE,
		V_CURRENT_TIME                AS MODIFY_TIME,
		V_CURRENT_TIME                AS LAST_TIME,
		ORG_CD,
		ORG_NAME,
		PROV,
		PROV_NAME,
		CITC,
		CITC_NAME,
		COUC,
		COUC_NAME,
		STAC,
		STAC_NAME,
		SSTC,
		SSTC_NAME,
		AREA_CD,
		AREA_NAME,
		AREA_PROV,
		AREA_PROV_NAME,
		AREA_CITC,
		AREA_CITC_NAME,
		AREA_COUC,
		AREA_COUC_NAME,
		AREA_TOWN,
		TOWN_NAME,
		AREA_VAGE,
		VAGE_NAME,
		AREA_GRUP,
		GRUP_NAME
	FROM
		R_PT_FOR_SEED_FM_Y
	WHERE
		DATA_STATE='1' AND BUSINESS_YEAR >= V_YEAR
	GROUP BY
		GROW_POINT_ID,
		GROW_POINT_CD,
		GROW_POINT_NAME,
		FOR_SEED_DATE,
		LEAF_VARIETY_CD,
		LEAF_VARIETY_NAME,
		BUSINESS_YEAR,
		ORG_CD,
		ORG_NAME,
		PROV,
		PROV_NAME,
		CITC,
		CITC_NAME,
		COUC,
		COUC_NAME,
		STAC,
		STAC_NAME,
		SSTC,
		SSTC_NAME,
		AREA_CD,
		AREA_NAME,
		AREA_PROV,
		AREA_PROV_NAME,
		AREA_CITC,
		AREA_CITC_NAME,
		AREA_COUC,
		AREA_COUC_NAME,
		AREA_TOWN,
		TOWN_NAME,
		AREA_VAGE,
		VAGE_NAME,
		AREA_GRUP,
		GRUP_NAME    
	WITH UR;    

COMMIT;	
	
END
@