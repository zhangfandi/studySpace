--DROP PROCEDURE DCCELL.P_R_PT_MQGL_INC_AB_D;
CREATE PROCEDURE DCCELL.P_R_PT_MQGL_INC_AB_D
BEGIN
    DECLARE V_YEAR            INTEGER;
	DECLARE V_CURRENT_TIME     TIMESTAMP;
	
	SET V_CURRENT_TIME = CURRENT TIMESTAMP;

    SELECT BUSI_YEAR INTO V_YEAR
    FROM DC_PROC_BUSI_YEAR A
    WHERE A.PROC_NAME = 'P_DC_CALL_ID_02_SC';

    DELETE FROM R_PT_MQGL_INC_AB_D where BUSINESS_YEAR>=V_YEAR;
    COMMIT;
	INSERT INTO R_PT_MQGL_INC_AB_D(
			MQGL_INC_AB_D_ID,
			GROW_POINT_ID,
			GROW_POINT_CD,
			GROW_POINT_NAME,
		    LEAF_TYPE_CD,
		    LEAF_TYPE_NAME,
			LEAF_VARIETY_CD,
			LEAF_VARIETY_NAME,
			GROW_TYPE,
			GROW_TYPE_NAME,
			EMERGE_QTY,
			BUSINESS_DATE,
			DATA_STATE,
			SEND_STATE,
			MODIFY_TIME,
            LAST_TIME,  
			BUSINESS_YEAR,
			ORG_CD,
			ORG_NAME,
			PROV,
			PROV_NAME,
			CITC,
			CITC_NAME,
			COUC,
			COUC_NAME,
			STAC,
			STAC_NAME,
			SSTC,
			SSTC_NAME,
			AREA_CD,
			AREA_NAME,
			AREA_PROV,
			AREA_PROV_NAME,
			AREA_CITC,
			AREA_CITC_NAME,
			AREA_COUC,
			AREA_COUC_NAME,
			AREA_TOWN,
			TOWN_NAME,
			AREA_VAGE,
			VAGE_NAME,
			AREA_GRUP,
			GRUP_NAME,
			CNTY ,
			CNTY_NAME ,
			CNTY_UNIQUE ,
			PROV_UNIQUE ,
			CITC_UNIQUE ,
			COUC_UNIQUE ,
			STAC_UNIQUE ,
			SSTC_UNIQUE ,
			SLIN_UNIQUE ,
			AREA_CNTY ,
			AREA_CNTY_NAME			
	)
	select 
        A.MQGL_INC_AB_D_ID,
        A.GROW_POINT_ID,
        A.GROW_POINT_CD,
        A.GROW_POINT_NAME,
        A.LEAF_TYPE_CD,
        B.ENUM_NAME AS LEAF_TYPE_NAME,
        A.LEAF_VARIETY_CD,
        C.LEAF_VARIETY_NAME,
        A.GROW_TYPE,
        D.ENUM_NAME AS GROW_TYPE_NAME,
        A.EMERGE_QTY,
        A.BUSINESS_DATE,
        '1' AS DATA_STATE,
        '0' AS SEND_STATE,
        V_CURRENT_TIME AS MODIFY_TIME,
        V_CURRENT_TIME AS LAST_TIME, 
        A.BUSINESS_YEAR,
        A.ORG_UNIQUE_CD AS ORG_CD,
        E.ORG_NAME,
        E.PROV,
        E.PROV_NAME,
        E.CITC,
        E.CITC_NAME,
        E.COUC,
        E.COUC_NAME,
        E.STAC,
        E.STAC_NAME,
        E.SSTC,
        E.SSTC_NAME,
        A.V_DIVISION_UNIQUE_CD AS  AREA_CD,
        F.ORG_NAME AS AREA_NAME,
        E.AREA_PROV,
        E.AREA_PROV_NAME,
        E.AREA_CITC,
        E.AREA_CITC_NAME,
        E.AREA_COUC,
        E.AREA_COUC_NAME,
        E.AREA_TOWN,
        E.TOWN_NAME,
        E.AREA_VAGE,
        E.VAGE_NAME,
        E.AREA_GRUP,
        E.GRUP_NAME,
		E.CNTY ,
		E.CNTY_NAME ,
		E.CNTY_UNIQUE ,
		E.PROV_UNIQUE ,
		E.CITC_UNIQUE ,
		E.COUC_UNIQUE ,
		E.STAC_UNIQUE ,
		E.SSTC_UNIQUE ,
		E.SLIN_UNIQUE ,
		E.AREA_CNTY ,
		E.AREA_CNTY_NAME			
	FROM 	
        (SELECT 
                MAX(A.DATA_STORE_BASE_TBL_ID) AS MQGL_INC_AB_D_ID,
                A.CLT_OBJ_ID AS GROW_POINT_ID,
                A.CLT_OBJ_CD AS GROW_POINT_CD,
                MAX(A.CLT_OBJ_NAME) AS GROW_POINT_NAME,
                A.C1 AS LEAF_TYPE_CD,
                A.C2 AS LEAF_VARIETY_CD,
                A.C3 AS GROW_TYPE,
                A.ORG_UNIQUE_CD,
                A.V_DIVISION_UNIQUE_CD,
                A.D2 AS BUSINESS_DATE,
                A.PT_YEAR AS BUSINESS_YEAR,
                SUM(COALESCE(A.N3,0)) AS EMERGE_QTY        
        FROM PT_DC_STAT_DATA_B A
        WHERE A.DATA_STATE='1'
        AND A.PT_YEAR >= V_YEAR
        AND A.BILL_NO='TJ19HB0000000001'
        GROUP BY  A.ORG_UNIQUE_CD,A.V_DIVISION_UNIQUE_CD,A.CLT_OBJ_ID,A.CLT_OBJ_CD,A.C1,A.C2,A.C3,A.PT_YEAR,A.D2
        ) A
        LEFT JOIN pt_ix_enum_data B ON A.LEAF_TYPE_CD=B.enum_cd AND B.idx_id='8a3c3453695cb23b01696bc1e7ce01bb' 
        LEFT JOIN CM_TB_LEAF_VARIETY C ON A.LEAF_VARIETY_CD=C.LEAF_VARIETY_CD AND C.DATA_STATE='1'
        LEFT JOIN pt_ix_enum_data D ON A.GROW_TYPE=D.enum_cd AND  D.idx_id='8a3c3453695cb23b01696b8410590191' 
        LEFT JOIN B_ORG E ON A.ORG_UNIQUE_CD=E.ORG_UNIQUE_CD
        LEFT JOIN B_DIVISION F ON A.V_DIVISION_UNIQUE_CD=F.DIVISION_UNIQUE_CD;

	COMMIT;
END
@