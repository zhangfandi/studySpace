--DROP PROCEDURE DCCELL.P_R_PT_FILM_RECY_FM_D;
CREATE PROCEDURE DCCELL.P_R_PT_FILM_RECY_FM_D
BEGIN
  DECLARE V_PROC_NAME               VARCHAR(1000) DEFAULT 'P_R_PT_FILM_RECY_FM_D';
  DECLARE V_STEP                    VARCHAR(500);
  DECLARE V_PT_YEAR                 INTEGER DEFAULT 2016;
  DECLARE V_BILL_NO                 VARCHAR(64) DEFAULT 'TJ00000000000059'; --单据编号
  DECLARE V_TIME_LAST               TIMESTAMP;
  DECLARE V_TIME_CURRENT            TIMESTAMP;
  DECLARE V_TIME_BEGIN              TIMESTAMP; --语句块开始执行时间
  DECLARE V_TIME_END                TIMESTAMP;   --语句块结束执行时间

  SET V_STEP = '1、取系统当前时间，和存储过程上次加工时间';
  SET V_TIME_CURRENT = CURRENT TIMESTAMP;

  SELECT TIME_STOP INTO V_TIME_LAST 
    FROM DCCELL.DC_PROC_TIME_STOP 
   WHERE PROC_NAME=V_PROC_NAME
  ;
  SELECT BUSI_YEAR INTO V_PT_YEAR 
    FROM DC_PROC_BUSI_YEAR A 
   WHERE A.PROC_NAME = 'P_DC_CALL_ID_02_SC'
  ;

  SET V_STEP = '3、将有修改过的数据涉及到的组织和行政，记录到临时表当中';


  SET V_STEP = '4、本次需要加工的数据如果已存在，则删除';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  DELETE FROM R_PT_FILM_RECY_FM_D T
   WHERE EXISTS (
           SELECT 1 
             FROM PT_DC_STAT_DATA_G DATA_TAB
            WHERE DATA_TAB.BILL_NO      = V_BILL_NO
              AND DATA_TAB.PT_YEAR    >= V_PT_YEAR
              AND DATA_TAB.CHECK_STATE = '1'
              AND DATA_TAB.MODIFY_TIME  > V_TIME_LAST
              AND T.FILM_RECY_FM_D_ID = DATA_TAB.DATA_STORE_BASE_TBL_ID
         )
     AND (CITC <> '5227' OR ORG_CD IS NULL OR ORG_CD = '0')
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);


  SET V_STEP = '已从业务表中删除的数据，需要从加工表中同步删除';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  DELETE FROM R_PT_FILM_RECY_FM_D T
   WHERE NOT EXISTS (
               SELECT 1 
                 FROM PT_DC_STAT_DATA_G DATA_TAB
                WHERE T.FILM_RECY_FM_D_ID = DATA_TAB.DATA_STORE_BASE_TBL_ID
         )
     AND (CITC <> '5227' OR ORG_CD IS NULL OR ORG_CD = '0')
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);


  SET V_STEP = '5、写入本次需要加工的数据';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  INSERT INTO R_PT_FILM_RECY_FM_D
  (
      FILM_RECY_FM_D_ID,
      FIELD_BLOCK_ID,
      FIELD_BLOCK_CD,
      FIELD_BLOCK_NAME,
      BUSINESS_YEAR,
      BUSINESS_DATE,
      COVER_AREA,
      RECY_ARA,
      PROPESS_AREA,
      SUBSIDE_MONEY,
      FARMER_ID,
      FARMER_CD,
      FARMER_NAME,
      ORG_CD,
      ORG_NAME,
      PROV,
      PROV_NAME,
      CITC,
      CITC_NAME,
      COUC,
      COUC_NAME,
      STAC,
      STAC_NAME,
      SSTC,
      SSTC_NAME,
      AREA_CD,
      AREA_NAME,
      AREA_PROV,
      AREA_PROV_NAME,
      AREA_CITC,
      AREA_CITC_NAME,
      AREA_COUC,
      AREA_COUC_NAME,
      AREA_TOWN,
      TOWN_NAME,
      AREA_VAGE,
      VAGE_NAME,
      AREA_GRUP,
      GRUP_NAME,
      TECHNICIAN_ID,
      SEND_STATE,
      DATA_STATE,
      MODIFY_TIME,
      LAST_TIME
  )
  SELECT DATA_TAB.DATA_STORE_BASE_TBL_ID AS FILM_RECY_FM_D_ID,
         DATA_TAB.CLT_OBJ_ID             AS FIELD_BLOCK_ID,
         DATA_TAB.CLT_OBJ_CD             AS FIELD_BLOCK_CD,
         DATA_TAB.CLT_OBJ_NAME           AS FIELD_BLOCK_NAME,
         DATA_TAB.PT_YEAR,
         DATA_TAB.FEEDBACK_DATE,
         DATA_TAB.N1                     AS COVER_AREA,
         DATA_TAB.N2                     AS RECY_ARA,
         DATA_TAB.N3                     AS PROPESS_AREA,
         DATA_TAB.N4                     AS SUBSIDE_MONEY,
         DATA_TAB.RELA_OBJECT_ID         AS FARMER_ID,
         DATA_TAB.RELA_OBJECT_CD         AS FARMER_CD,
         DATA_TAB.RELA_OBJECT_NAME FARMER_NAME,
         ORG.ORG_CD,
         ORG.ORG_NAME,
         ORG.PROV,
         ORG.PROV_NAME,
         ORG.CITC,
         ORG.CITC_NAME,
         ORG.COUC,
         ORG.COUC_NAME,
         ORG.STAC,
         ORG.STAC_NAME,
         ORG.SSTC,
         ORG.SSTC_NAME,
         DIVISION.ORG_CD,
         DIVISION.ORG_NAME,
         DIVISION.AREA_PROV,
         DIVISION.AREA_PROV_NAME,
         DIVISION.AREA_CITC,
         DIVISION.AREA_CITC_NAME,
         DIVISION.AREA_COUC,
         DIVISION.AREA_COUC_NAME,
         DIVISION.AREA_TOWN,
         DIVISION.TOWN_NAME,
         DIVISION.AREA_VAGE,
         DIVISION.VAGE_NAME,
         DIVISION.AREA_GRUP,
         DIVISION.GRUP_NAME,
         DATA_TAB.FEEDBACK_PSN_ID,
         '0',
         '1',
         DATA_TAB.MODIFY_TIME,
         V_TIME_CURRENT
    FROM PT_DC_STAT_DATA_G DATA_TAB
         --LEFT JOIN V_R_FARMER FARMER ON FARMER.FARMER_ID = DATA_TAB.RELA_OBJECT_ID AND FARMER.BUSINESS_YEAR = V_PT_YEAR
         LEFT JOIN CM_PM_FRM_FUND FARMER  ON FARMER.FRM_FUND_UNIQUE_ID = DATA_TAB.RELA_OBJECT_ID AND FARMER.BIZ_YEAR = V_PT_YEAR AND FARMER.DATA_STATE = '1'
         LEFT JOIN B_ORG ORG ON ORG.ORG_UNIQUE_CD = FARMER.STATION_UNIQUE_CD
         LEFT JOIN B_DIVISION DIVISION ON DIVISION.DIVISION_UNIQUE_CD = FARMER.DIVISION_UNIQUE_CD
   WHERE DATA_TAB.BILL_NO      = V_BILL_NO
     AND DATA_TAB.DATA_STATE = '1'
     AND DATA_TAB.CHECK_STATE = '1'
     AND DATA_TAB.PT_YEAR    >= V_PT_YEAR
     AND DATA_TAB.MODIFY_TIME  > V_TIME_LAST
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);


  SET V_STEP = '6、删除行政表所有数据，采用全量加工';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  DELETE FROM R_PT_FILM_RECY_DV_D T
   WHERE T.BUSINESS_YEAR >= V_PT_YEAR
     AND DATA_STATE    = '1'
     AND (CITC <> '5227' OR ORG_CD IS NULL OR ORG_CD = '0')
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);


  SET V_STEP = '7、重新统计行政表数据';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  INSERT INTO R_PT_FILM_RECY_DV_D
  (
      FILM_RECY_DV_D_ID,
      BUSINESS_YEAR,
      BUSINESS_DATE,
      COVER_AREA,
      RECY_ARA,
      PROPESS_AREA,
      SUBSIDE_MONEY,
      ORG_CD,
      ORG_NAME,
      PROV,
      PROV_NAME,
      CITC,
      CITC_NAME,
      COUC,
      COUC_NAME,
      STAC,
      STAC_NAME,
      SSTC,
      SSTC_NAME,
      AREA_CD,
      AREA_NAME,
      AREA_PROV,
      AREA_PROV_NAME,
      AREA_CITC,
      AREA_CITC_NAME,
      AREA_COUC,
      AREA_COUC_NAME,
      AREA_TOWN,
      TOWN_NAME,
      AREA_VAGE,
      VAGE_NAME,
      AREA_GRUP,
      GRUP_NAME,
      SEND_STATE,
      DATA_STATE,
      MODIFY_TIME,
      LAST_TIME
  )
  SELECT HEX(GENERATE_UNIQUE()) AS FILM_RECY_DV_D_ID,
         BUSINESS_YEAR,
         BUSINESS_DATE,
         SUM(COVER_AREA)        AS COVER_AREA,
         SUM(RECY_ARA)          AS RECY_ARA,
         SUM(PROPESS_AREA)      AS PROPESS_AREA,
         SUM(SUBSIDE_MONEY)     AS SUBSIDE_MONEY,
         ORG_CD,
         ORG_NAME,
         PROV,
         PROV_NAME,
         CITC,
         CITC_NAME,
         COUC,
         COUC_NAME,
         STAC,
         STAC_NAME,
         SSTC,
         SSTC_NAME,
         AREA_CD,
         AREA_NAME,
         AREA_PROV,
         AREA_PROV_NAME,
         AREA_CITC,
         AREA_CITC_NAME,
         AREA_COUC,
         AREA_COUC_NAME,
         AREA_TOWN,
         TOWN_NAME,
         AREA_VAGE,
         VAGE_NAME,
         AREA_GRUP,
         GRUP_NAME,
         '0',
         '1',
         MAX(MODIFY_TIME),
         V_TIME_CURRENT
    FROM R_PT_FILM_RECY_FM_D T
   WHERE T.BUSINESS_YEAR >= V_PT_YEAR
   GROUP BY
         T.BUSINESS_YEAR,
         T.BUSINESS_DATE,
         T.ORG_CD,
         T.ORG_NAME,
         T.PROV,
         T.PROV_NAME,
         T.CITC,
         T.CITC_NAME,
         T.COUC,
         T.COUC_NAME,
         T.STAC,
         T.STAC_NAME,
         T.SSTC,
         T.SSTC_NAME,
         T.AREA_CD,
         T.AREA_NAME,
         T.AREA_PROV,
         T.AREA_PROV_NAME,
         T.AREA_CITC,
         T.AREA_CITC_NAME,
         T.AREA_COUC,
         T.AREA_COUC_NAME,
         T.AREA_TOWN,
         T.TOWN_NAME,
         T.AREA_VAGE,
         T.VAGE_NAME,
         T.AREA_GRUP,
         T.GRUP_NAME
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);


  SET V_STEP = '8、删除组织表所有数据，采用全量加工';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  DELETE FROM R_PT_FILM_RECY_CB_D T
   WHERE T.BUSINESS_YEAR >= V_PT_YEAR
     AND (CITC <> '5227' OR ORG_CD IS NULL OR ORG_CD = '0')
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);


  SET V_STEP = '9、重新统计组织表数据';
  SET V_TIME_BEGIN = CURRENT TIMESTAMP;
  INSERT INTO R_PT_FILM_RECY_CB_D
  (
      FILM_RECY_CB_D_ID,
      BUSINESS_YEAR,
      BUSINESS_DATE,
      COVER_AREA,
      RECY_ARA,
      PROPESS_AREA,
      SUBSIDE_MONEY,
      ORG_CD,
      ORG_NAME,
      PROV,
      PROV_NAME,
      CITC,
      CITC_NAME,
      COUC,
      COUC_NAME,
      STAC,
      STAC_NAME,
      SSTC,
      SSTC_NAME,
      SEND_STATE,
      DATA_STATE,
      MODIFY_TIME,
      LAST_TIME
  )
  SELECT HEX(GENERATE_UNIQUE()) AS FILM_RECY_CB_D_ID,
         BUSINESS_YEAR,
         BUSINESS_DATE,
         SUM(COVER_AREA),
         SUM(RECY_ARA),
         SUM(PROPESS_AREA),
         SUM(SUBSIDE_MONEY),
         ORG_CD,
         ORG_NAME,
         PROV,
         PROV_NAME,
         CITC,
         CITC_NAME,
         COUC,
         COUC_NAME,
         STAC,
         STAC_NAME,
         SSTC,
         SSTC_NAME,
         '0',
         '1',
         MAX(MODIFY_TIME),
         V_TIME_CURRENT
    FROM R_PT_FILM_RECY_DV_D T
   WHERE T.BUSINESS_YEAR >= V_PT_YEAR
   GROUP BY
         T.BUSINESS_YEAR,
         T.BUSINESS_DATE,
         T.ORG_CD,
         T.ORG_NAME,
         T.PROV,
         T.PROV_NAME,
         T.CITC,
         T.CITC_NAME,
         T.COUC,
         T.COUC_NAME,
         T.STAC,
         T.STAC_NAME,
         T.SSTC,
         T.SSTC_NAME
  WITH UR
  ;
  INSERT INTO PROC_TIME_TOTAL(PROC_NAME, REMARK, BEGIN_TIME, EXEC_TIME) VALUES (V_PROC_NAME, V_STEP, V_TIME_BEGIN, V_TIME_CURRENT);

  COMMIT;


  SET V_STEP = '10、更新存储过程执行时间';
  UPDATE DCCELL.DC_PROC_TIME_STOP 
     SET TIME_STOP = V_TIME_CURRENT 
   WHERE PROC_NAME=V_PROC_NAME
  ;


  SET V_STEP = '11、将本次加工后，ORG_CD为空的业务数据，modify_time重置为current timestamp';
  UPDATE PT_DC_STAT_DATA_G G SET MODIFY_TIME = CURRENT TIMESTAMP
  WHERE EXISTS (
          SELECT 1 
            FROM R_PT_FILM_RECY_FM_D D
           WHERE D.FILM_RECY_FM_D_ID = G.DATA_STORE_BASE_TBL_ID
             AND (D.ORG_CD IS NULL OR D.ORG_CD = '0')
        )
  ;
  
  COMMIT;
END
@